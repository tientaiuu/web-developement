<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Danh mục Sách | Readify</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="assets/images/logo.svg" type="image/svg+xml">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
 <link rel="stylesheet" href="./assets/css/home.css">
 <link rel="stylesheet" href="./assets/css/books.css">

  <script src="./assets/js/home.js"></script>
<script src="../assets/js/callHeaderFooter.js"></script>

<script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#f5f5dc',
            secondary: '#e6e6e6',
            primarynavy: '#2d5aa0'
          },
          borderRadius: {
            'none': '0px',
            'sm': '4px',
            DEFAULT: '8px',
            'md': '12px',
            'lg': '16px',
            'xl': '20px',
            '2xl': '24px',
            '3xl': '32px',
            'full': '9999px',
            'button': '8px'
          }
        }
      }
    }
  </script>
  
</head>
<body class="bg-[#fafaf3]">
  <!-- Header -->
  <div id="header-placeholder"></div>

  <!-- Breadcrumb -->
  <div class="container mx-auto px-4">
    <nav class="text-sm text-gray-500 py-4 flex items-center gap-2" aria-label="Breadcrumb">
      <a href="/" class="hover:underline text-primarynavy font-semibold font-medium flex items-center gap-1">
        <i class="ri-home-5-line text-base"></i> Home
      </a>
      <span class="mx-1 text-primarynavy">/</span>
      <span class="text-primarynavy">Books</span>
    </nav>
  </div>

  <!-- Hero Section  -->
  <section class="w-full flex flex-col items-center justify-center text-center py-8 md:py-14 ">
    <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-6">Books</h1>
    <img src="https://thumbs.readings.com.au/wICW0A42zjnSQIi8K966NlHNXmk=/https://readings-v4-production.s3.amazonaws.com/assets/e11/c97/206/e11c9720643f5e790d0683a7d03b01562fc25440/Oslo-Davis-Readings-2024-Books-Large.png" alt="Books Illustration" class="mx-auto mb-8 max-w-[500px] w-full h-auto" style="filter: grayscale(1);" loading="lazy">
    <p class="text-lg md:text-xl text-gray-700 max-w-3xl mx-auto mt-2">
     Khám phá kho tàng tri thức, chạm đến cảm hứng và mở rộng thế giới của bạn qua từng trang sách được chọn lọc bởi Readify.
    </p>
  </section>
  <!-- End Hero Section -->
  
  <!-- Main Content -->
  <div class="main-content container mx-auto px-4 py-8">
     <!-- Section: New Fiction -->
    <section class="mb-12">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-2">
      <div>
        <h2 class="text-2xl font-bold text-primarynavy mb-1 flex items-center gap-2">
         New Books
        </h2>
        <p class="text-gray-600 text-sm max-w-xl">Khám phá những cuốn sách mới nhất vừa ra mắt, cập nhật liên tục các tác phẩm nổi bật từ nhiều thể loại khác nhau.</p>
      </div>
      <a href="#" class="text-primarynavy text-sm font-medium hover:underline whitespace-nowrap" onclick="document.getElementById('book-listings').scrollIntoView({behavior: 'smooth'}); return false;">Xem tất cả &rarr;</a>
    </div>
    <div id="newFictionBooksGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-8 items-stretch"></div>
  </section>
  
     <!-- Section: Bestselling books -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-4">

        
      <div>
        <h2 class="text-2xl font-bold text-primarynavy mb-1 flex items-center gap-2">
          Bestselling books
        </h2>
        <p class="text-gray-600 text-sm max-w-xl">Khám phá những cuốn sách bán chạy nhất.</p>
      </div>
      <a href="#" class="text-primarynavy text-sm font-medium hover:underline whitespace-nowrap" onclick="document.getElementById('book-listings').scrollIntoView({behavior: 'smooth'}); return false;">Xem tất cả &rarr;</a>
      </div>
      <div id="bestsellerBooksGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-6 gap-6"></div>
    </section>
    <!-- Section: Highly Recommended books -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-4">
        
      <div>
        <h2 class="text-2xl font-bold text-primarynavy mb-1 flex items-center gap-2">
           Highly Recommended
        </h2>
        <p class="text-gray-600 text-sm max-w-xl">Khám phá những cuốn sách được yêu thích và đánh giá cao nhất.</p>
      </div>
      <a href="#" class="text-primarynavy text-sm font-medium hover:underline whitespace-nowrap" onclick="document.getElementById('book-listings').scrollIntoView({behavior: 'smooth'}); return false;">Xem tất cả &rarr;</a>
      </div>
      <div id="recommendedBooksGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-6 gap-6"></div>
    </section>
   

    <div class="flex flex-col md:flex-row gap-8">
    
      <!-- Book Listings -->
      <section id="book-listings" class="w-full">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-primarynavy mb-1 flex items-center gap-2">
           Toàn bộ sách
        </h2>
          <p class="text-gray-600">Hơn 1k+ sách có sẵn tại đây, tìm ngay!</p>
        </div>
        <div id="booksGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-8 items-stretch fadein">
          <!-- Book cards sẽ được render ở đây -->
        </div>
        <div class="pagination" id="pagination"></div>
      </section>
    </div>

   
  </div>

    <div id="footer-placeholder"></div>

  <script>
    // User popover logic
    document.addEventListener('DOMContentLoaded', function() {
      const userBtn = document.getElementById('userBtn');
      const userPopover = document.getElementById('userPopover');
      if(userBtn && userPopover) {
        userBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          userPopover.classList.toggle('hidden');
        });
        document.addEventListener('click', function(e) {
          if (!userPopover.contains(e.target) && e.target !== userBtn) {
            userPopover.classList.add('hidden');
          }
        });
      }
    });

    // Lấy dữ liệu sách từ backend (đọc từ file CSV)
    let books = [];
    const PAGE_SIZE = 12;
    let currentPage = 1;
    let currentCategory = "all";
    let filteredBooks = books;

    // --- SEARCH & FILTER LOGIC ---
    // Lấy query từ URL
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name) || '';
    }

    // State
    let searchKeyword = getQueryParam('query') || '';

    // Sửa fetchBooksFromBackend để lấy đúng các trường từ API mới
    async function fetchBooksFromBackend() {
      try {
        let url;
        if (searchKeyword) {
          url = `http://localhost:5000/api/books/search?keyword=${encodeURIComponent(searchKeyword)}`;
        } else {
          url = 'http://localhost:5000/api/books';
        }
        const response = await fetch(url);
        if (!response.ok) throw new Error('Lỗi khi lấy dữ liệu sách');
        const data = await response.json();
        // API trả về mảng sách với các trường: _id, title, author (object), category (object), price, imageUrl, ...
        const rawBooks = Array.isArray(data) ? data : (data.books || data.Books || data.data || []);
        books = rawBooks.map((book, idx) => {
          const price = Number(book.price) || 0;
          const discount = Math.random() * 0.25; // 0-25%
          const newPrice = Math.round(price * (1 - discount));
          // Random rating từ 4.5 đến 5.0
          const rating = (Math.random() * 0.5 + 4.5).toFixed(2);
          // Random n_review từ 10 đến 200
          const n_review = Math.floor(Math.random() * 191) + 10;
          return {
            id: book._id || book.id || idx + 1,
            title: book.title || '',
            author: book.author?.name || (typeof book.author === 'string' ? book.author : ''),
            category: book.category?.name || (typeof book.category === 'string' ? book.category : ''),
            price: newPrice,
            oldPrice: price > newPrice ? price : undefined,
            image: book.imageUrl || book.cover_link || '',
            rating: Number(rating),
            n_review: n_review,
            quantity: Number(book.quantity) || 0
          };
        });
        filteredBooks = books;
        renderBooks(currentCategory, 1);
        renderSpecialBookSections();
        renderNewFictionSection();
      } catch (error) {
        document.getElementById("booksGrid").innerHTML = `<div class=\"text-center text-gray-500 py-12 text-lg col-span-full\">Không thể tải danh sách sách!</div>`;
        document.getElementById("pagination").innerHTML = "";
      }
    }

    // Cho phép gọi lại searchBooksByKeyword từ home.js
    function searchBooksByKeyword(keyword) {
      window.searchKeyword = keyword;
      fetchBooksFromBackend();
    }
    function renderBooks(category, page = 1) {
      const grid = document.getElementById("booksGrid");
      grid.classList.remove("fadein");
      grid.classList.add("fadeout");
      setTimeout(() => {
        currentCategory = category;
        filteredBooks = (category && category !== "all") ? books.filter(b => b.category === category) : books;
        const totalPages = Math.ceil(filteredBooks.length / PAGE_SIZE);
        currentPage = page; 

        grid.innerHTML = "";

        if (filteredBooks.length === 0) {
          grid.innerHTML = `<div class="text-center text-gray-500 py-12 text-lg col-span-full">Không có sách nào thuộc thể loại này.</div>`;
          document.getElementById("pagination").innerHTML = "";
          grid.classList.remove("fadeout");
          grid.classList.add("fadein");
          return;
        }

        const start = (currentPage - 1) * PAGE_SIZE;
        const end = start + PAGE_SIZE;
  filteredBooks.slice(start, end).forEach(book => {
  grid.innerHTML += `
    <div class="bg-white rounded shadow-sm overflow-hidden flex flex-col h-full transition group cursor-pointer book-card-item" data-id="${book.id}">
      <div class="relative h-96 w-full flex-shrink-0">
        <img src="${book.image}" alt="${book.title}" class="w-full h-full object-cover object-top">
        <button class="absolute top-2 right-2 w-9 h-9 flex items-center justify-center fav-btn bg-[#eaeaea]/90 rounded-full transition shadow-sm" title="Yêu thích">
          <i class="ri-star-line text-gray-800"></i>
        </button>
        <span class="absolute top-2 left-2 bg-[#eaeaea]/90 text-[#f7931e] shadow-sm text-xs font-semibold px-2 py-1 rounded-full flex items-center gap-1 shadow-sm" title="Đánh giá">
            <i class="ri-star-s-fill text-[#f7931e] text-base"></i> ${book.rating.toFixed(1)}
        </span>
      </div>
      <div class="p-4 flex flex-col flex-1">
        <div class="text-xs text-gray-500 mb-1">${book.category}</div>
        <h3 class="font-semibold text-gray-800 mb-1">${book.title}</h3>
        <p class="text-sm text-gray-600 mb-3">${book.author}</p>
        <div class="flex justify-between items-center mt-auto">
          <div>
            <span class="font-semibold text-primarynavy">${book.price.toLocaleString()}₫</span>
            ${book.oldPrice ? `<span class="text-sm text-gray-500 line-through ml-2">${book.oldPrice.toLocaleString()}₫</span>` : ""}
          </div>
          <button class="add-to-cart-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-[8px] whitespace-nowrap transition">Thêm vào giỏ</button>
        </div>
      </div>
    </div>
  `;
});
        // Thêm sự kiện click cho card sách để chuyển sang trang chi tiết
        setTimeout(() => {
          document.querySelectorAll('.book-card-item').forEach(card => {
            card.addEventListener('click', function(e) {
              if (e.target.closest('.fav-btn') || e.target.closest('.add-to-cart-btn')) return;
              const id = this.getAttribute('data-id');
              // Lấy đúng object book đã render cho card này (từ filteredBooks, không phải từ API gốc)
              const book = filteredBooks.find(b => String(b.id) === String(id));
              if (!book) return;
              sessionStorage.setItem('selectedBook', JSON.stringify(book));
              function toSlug(str) {
                return str
                  .toLowerCase()
                  .normalize('NFD')
                  .replace(/[\u0300-\u036f]/g, '')
                  .replace(/đ/g, 'd')
                  .replace(/[^a-z0-9\s-]/g, '')
                  .replace(/\s+/g, '-')
                  .replace(/-+/g, '-')
                  .replace(/^-+|-+$/g, '');
              }
              const slug = `${toSlug(book.title)}`;
              window.location.href = `${window.location.origin}/books/${slug}`;
            });
          });
        }, 0);

        // Hiệu ứng khi bấm "Thêm vào giỏ"
        document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Ngăn click lan ra ngoài làm lệch layout
            const originalWidth = btn.offsetWidth;
            btn.innerHTML = "✔ Đã thêm";
            btn.classList.add("bg-green-500", "text-white");

            btn.style.width = originalWidth + "px";
            btn.style.minWidth = originalWidth + "px";
            setTimeout(() => {
              btn.innerHTML = "Thêm vào giỏ";
              btn.classList.remove("bg-green-500", "text-white");
              btn.style.width = "";
              btn.style.minWidth = "";
            }, 1200);
          });
        });

        // Hiệu ứng khi bấm "Yêu thích"
        document.querySelectorAll('.fav-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            btn.classList.toggle("faved");
            const icon = btn.querySelector("i");
            if (btn.classList.contains("faved")) {
              icon.classList.remove("ri-star-line");
              icon.classList.add("ri-star-fill");
            } else {
              icon.classList.remove("ri-star-fill");
              icon.classList.add("ri-star-line");
            }
          });
        });

        // Render phân trang
        renderPagination(totalPages);

        grid.classList.remove("fadeout");
        grid.classList.add("fadein");
      }, 200);
    }

    function renderPagination(totalPages) {
      const pag = document.getElementById("pagination");
      pag.innerHTML = "";
      if (totalPages <= 1) return;
      // Prev
      pag.innerHTML += `<button class="pagination-btn" ${currentPage === 1 ? "disabled" : ""} data-page="${currentPage - 1}"><i class="ri-arrow-left-s-line"></i></button>`;

      // Hiển thị rút gọn phân trang với input tìm trang
      let pageList = [];
      if (totalPages <= 9) {
        for (let i = 1; i <= totalPages; i++) pageList.push(i);
      } else {
        pageList = [1];
        if (currentPage > 4) pageList.push('...');
        for (let i = Math.max(2, currentPage - 2); i <= Math.min(totalPages - 1, currentPage + 2); i++) {
          pageList.push(i);
        }
        if (currentPage < totalPages - 3) pageList.push('...');
        pageList.push(totalPages);
      }
      pageList.forEach(i => {
        if (i === '...') {
          pag.innerHTML += `<span class="pagination-ellipsis">...</span>`;
        } else {
          pag.innerHTML += `<button class="pagination-btn${i === currentPage ? " active" : ""}" data-page="${i}">${i}</button>`;
        }
      });
      // Next
      pag.innerHTML += `<button class="pagination-btn" ${currentPage === totalPages ? "disabled" : ""} data-page="${currentPage + 1}"><i class="ri-arrow-right-s-line"></i></button>`;

      // Thêm input tìm trang
      pag.innerHTML += `<span class="ml-4 flex items-center gap-1"><input id="gotoPageInput" type="number" min="1" max="${totalPages}" placeholder="Tới trang..." class="border border-gray-300 rounded px-2 py-1 w-20 text-center text-sm focus:ring-2 focus:ring-primarynavy" style="margin-left:8px;"/><button id="gotoPageBtn" class="ml-1 px-2 py-1 rounded bg-primarynavy text-white text-sm">Tìm</button></span>`;

      document.querySelectorAll('.pagination-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const page = Number(this.getAttribute('data-page'));
          if (!isNaN(page) && page >= 1 && page <= totalPages && page !== currentPage) {
            renderBooks(currentCategory, page);
            // Trượt lên phần Book Listings sau khi đổi trang
            const bookListings = document.getElementById('book-listings');
            if (bookListings) bookListings.scrollIntoView({behavior: 'smooth'});
          }
        });
      });
      // Xử lý tìm trang
      const gotoInput = document.getElementById('gotoPageInput');
      const gotoBtn = document.getElementById('gotoPageBtn');
      gotoBtn.addEventListener('click', function() {
        const val = Number(gotoInput.value);
        if (!isNaN(val) && val >= 1 && val <= totalPages) {
          renderBooks(currentCategory, val);
          const bookListings = document.getElementById('book-listings');
          if (bookListings) bookListings.scrollIntoView({behavior: 'smooth'});
        } else {
          gotoInput.classList.add('ring-2', 'ring-red-400');
          setTimeout(()=>gotoInput.classList.remove('ring-2', 'ring-red-400'), 1200);
        }
      });
      gotoInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') gotoBtn.click();
      });
    }

  

    document.addEventListener('DOMContentLoaded', function() {
      // Lấy danh sách sách từ backend (có hỗ trợ search)
      fetchBooksFromBackend();
    });

 

    function renderSpecialBookCard(book, section) {
  return `
    <div class="bg-white rounded shadow-sm overflow-hidden flex flex-col h-full transition group cursor-pointer book-card-item" data-id="${book.id}">
      <div class="relative h-96 w-full flex-shrink-0">
        <img src="${book.image}" alt="${book.title}" class="w-full h-full object-cover object-top">
        <button class="absolute top-2 right-2 w-9 h-9 flex items-center justify-center fav-btn bg-[#eaeaea]/90 rounded-full transition shadow-sm" title="Yêu thích">
          <i class="ri-star-line text-gray-800"></i>
        </button>
        <span class="absolute top-2 left-2 bg-[#eaeaea]/90 text-[#f7931e] shadow-sm text-xs font-semibold px-2 py-1 rounded-full flex items-center gap-1 shadow-sm" title="Đánh giá">
            <i class="ri-star-s-fill text-[#f7931e] text-base"></i> ${book.rating.toFixed(1)}
        </span>
      </div>
      <div class="p-4 flex flex-col flex-1">
        <div class="text-xs text-gray-500 mb-1">${book.category}</div>
        <h3 class="font-semibold text-gray-800 mb-1">${book.title}</h3>
        <p class="text-sm text-gray-600 mb-3">${book.author}</p>
        <div class="flex justify-between items-center mt-auto">
          <div>
            <span class="font-semibold text-primarynavy">${book.price.toLocaleString()}₫</span>
            ${book.oldPrice ? `<span class="text-sm text-gray-500 line-through ml-2">${book.oldPrice.toLocaleString()}₫</span>` : ""}
          </div>
          <button class="add-to-cart-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-[8px] whitespace-nowrap transition">Thêm vào giỏ</button>
        </div>
      </div>
    </div>
  `;
}

// Hàm lấy ngẫu nhiên n phần tử từ mảng
function getRandomBooks(arr, n) {
  const result = arr.slice();
  for (let i = result.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [result[i], result[j]] = [result[j], result[i]];
  }
  return result.slice(0, n);
}

// Đảm bảo các section sử dụng bookcard mới
function renderSpecialBookSections() {
  // Bestselling: nhiều review (>20), random 8 cuốn
  const bestsellersPool = books.filter(b => b.n_review > 20);
  const bestsellers = getRandomBooks(bestsellersPool, 8);
  const bestsellerGrid = document.getElementById('bestsellerBooksGrid');
  if (bestsellerGrid) {
    bestsellerGrid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-8 items-stretch';
    bestsellerGrid.innerHTML = bestsellers.map(book => renderSpecialBookCard(book)).join('');
  }
  // Highly Recommended: rating >= 4.9, random 8 cuốn
  const recommendedPool = books.filter(b => b.rating >= 4.9);
  const recommended = getRandomBooks(recommendedPool, 8);
  const recommendedGrid = document.getElementById('recommendedBooksGrid');
  if (recommendedGrid) {
    recommendedGrid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-8 items-stretch';
    recommendedGrid.innerHTML = recommended.map(book => renderSpecialBookCard(book)).join('');
  }
}
function renderNewFictionSection() {
  // New Fiction: sách mới nhất dựa trên createdAt hoặc updatedAt
  let sortedBooks = books.slice().sort((a, b) => {
    const dateA = new Date(a.updatedAt || a.createdAt || 0);
    const dateB = new Date(b.updatedAt || b.createdAt || 0);
    return dateB - dateA;
  });
  if (sortedBooks.length === 0) return;
  // Lấy ngày mới nhất
  const newestDate = sortedBooks[0].updatedAt || sortedBooks[0].createdAt;
  // Lọc tất cả sách có cùng ngày mới nhất
  const newestBooks = sortedBooks.filter(b => {
    const d = b.updatedAt || b.createdAt;
    return d === newestDate;
  });
  // Nếu số lượng > 8 thì random 8 cuốn, ngược lại lấy hết
  let displayBooks = newestBooks;
  if (newestBooks.length > 8) {
    const shuffled = newestBooks.sort(() => Math.random() - 0.5);
    displayBooks = shuffled.slice(0, 8);
  }
  const grid = document.getElementById('newFictionBooksGrid');
  if (grid) {
    grid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-8 items-stretch';
    grid.innerHTML = displayBooks.map(book => renderSpecialBookCard(book)).join('');
  }
}

  </script>
</body>
</html>